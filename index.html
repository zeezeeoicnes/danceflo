<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance Flo - Graffiti Mix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Bangers&family=Outfit:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --fnf-pink: #ff00ff;
            --fnf-cyan: #00ffff;
            --fnf-yellow: #fff000;
            --note-left: #c24b99;
            --note-down: #00ffff;
            --note-up: #12fa05;
            --note-right: #f9393f;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #080808;
            font-family: 'Outfit', sans-serif;
            color: white;
            user-select: none;
            touch-action: manipulation;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        .ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ui-layer > * { pointer-events: auto; }

        .screen { display: none; width: 100%; height: 100%; position: relative; }
        .screen.active { display: flex; flex-direction: column; }

        .logo-bop {
            animation: logo-bop 0.4s infinite alternate cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Permanent Marker', cursive;
            filter: drop-shadow(0 0 15px var(--fnf-pink));
        }
        @keyframes logo-bop {
            from { transform: scale(1) rotate(-3deg); }
            to { transform: scale(1.15) rotate(3deg); }
        }

        .street-menu-btn {
            font-family: 'Permanent Marker', cursive;
            font-size: 5rem;
            cursor: pointer;
            text-shadow: 8px 8px 0px #000;
            transition: all 0.2s;
            position: relative;
            padding: 0 40px;
            color: white;
        }
        .street-menu-btn:hover {
            transform: scale(1.1) translateX(30px) rotate(-2deg);
            color: var(--fnf-cyan);
            text-shadow: 12px 12px 0px var(--fnf-pink);
        }

        .osu-container {
            display: flex; width: 100%; height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        .song-preview-side {
            width: 40%; display: flex; flex-direction: column; justify-content: center; padding: 60px;
        }
        .song-list-side {
            width: 60%; overflow-y: auto; padding: 120px 40px;
            scrollbar-width: none;
        }
        .osu-card {
            background: rgba(30,30,30,0.9);
            margin-bottom: 20px;
            padding: 25px 50px;
            border-right: 20px solid transparent;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: perspective(1000px) rotateY(-10deg);
            display: flex; flex-direction: column;
            align-items: flex-end;
            text-align: right;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .osu-card.active {
            background: #fff;
            color: #000;
            border-right: 20px solid var(--fnf-pink);
            transform: perspective(1000px) rotateY(-20deg) scale(1.1) translateX(-40px);
            box-shadow: 0 0 50px rgba(255,0,255,0.3);
        }
        .osu-card .title { font-weight: 900; font-size: 2.5rem; text-transform: uppercase; line-height: 1; }
        .osu-card .artist { font-size: 1.2rem; font-weight: 400; opacity: 0.8; }

        .highway { position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 100%; display: flex; gap: 25px; }
        .lane { width: 110px; height: 100%; position: relative; background: rgba(255,255,255,0.03); pointer-events: auto; cursor: pointer; }
        
        .receptor {
            position: absolute; bottom: 80px; width: 100px; height: 100px;
            border: 6px solid rgba(255,255,255,0.2); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 60px; left: 5px; transition: transform 0.05s, background-color 0.05s;
            pointer-events: none;
        }
        .receptor.hit { transform: scale(0.8); border-color: #fff; background: rgba(255,255,255,0.3); }

        .note { 
            position: absolute; width: 100px; height: 100px; border-radius: 15px;
            display: flex; align-items: center; justify-content: center; font-size: 60px;
            left: 5px; box-shadow: 0 10px 0px rgba(0,0,0,0.4); font-weight: bold;
            pointer-events: none; z-index: 50;
        }

        .hp-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 500px; height: 25px; background: #111; border: 4px solid #fff;
        }
        .hp-fill { height: 100%; background: linear-gradient(to right, var(--fnf-pink), var(--fnf-cyan)); transition: width 0.1s; }

        .judgement {
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Permanent Marker', cursive; font-size: 8rem; pointer-events: none; opacity: 0;
            text-shadow: 10px 10px 0px #000; -webkit-text-stroke: 3px white;
        }
        .animate-judgement { animation: graffiti-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.5) forwards; }
        
        @keyframes graffiti-bounce {
            0% { opacity: 0; transform: translate(-50%, -20%) scale(0.2) rotate(-20deg); }
            40% { opacity: 1; transform: translate(-50%, -50%) scale(1.2) rotate(10deg); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1) rotate(0deg); }
        }

        /* LOADING UI */
        #loading-overlay {
            position: fixed; inset: 0; background: black; z-index: 100; display: none;
            flex-direction: column; justify-content: center; align-items: center; 
        }
        .loading-text {
            font-family: 'Permanent Marker', cursive; font-size: 5rem;
            animation: beat 0.5s infinite alternate ease-in-out;
            text-shadow: 5px 5px 0 var(--fnf-pink);
            color: white;
        }
        @keyframes beat {
            from { transform: scale(1) rotate(-2deg); }
            to { transform: scale(1.1) rotate(2deg); }
        }

        /* RESULTS SCREEN */
        .rank-badge {
            font-family: 'Permanent Marker', cursive;
            font-size: 15rem;
            line-height: 1;
            text-shadow: 15px 15px 0px var(--fnf-pink);
            animation: rank-appear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes rank-appear {
            0% { transform: scale(5); opacity: 0; filter: blur(20px); }
            100% { transform: scale(1); opacity: 1; filter: blur(0); }
        }
    </style>
</head>
<body class="bg-black">

    <div id="loading-overlay">
        <div class="loading-text">TAPPING THE STREETS...</div>
        <div class="text-white mt-4 font-bold animate-pulse text-2xl">BUFFING UP AUDIO</div>
    </div>

    <canvas id="bg-canvas"></canvas>

    <div class="ui-layer">
        <!-- Title Screen -->
        <div id="screen-title" class="screen active justify-center items-center cursor-pointer" onclick="app.toMenu()">
            <div class="logo-bop text-[15rem] leading-none mb-10 text-pink-500 text-center" style="text-shadow: 15px 15px 0 #fff">DANCE<br>FLO</div>
            <div class="font-['Permanent_Marker'] text-5xl text-white">CLICK ANYWHERE</div>
        </div>

        <!-- Main Menu -->
        <div id="screen-main" class="screen items-start justify-center pl-24">
            <div class="flex flex-col items-start space-y-2">
                <div class="street-menu-btn" onclick="app.showScreen('screen-select')">PLAY</div>
                <div class="street-menu-btn" onclick="app.showScreen('screen-main')">SETTINGS</div>
                <div class="street-menu-btn" onclick="app.showScreen('screen-main')">CREDITS</div>
                <div class="street-menu-btn" onclick="window.location.reload()">EXIT</div>
            </div>
        </div>

        <!-- Song Select -->
        <div id="screen-select" class="screen">
            <div class="osu-container">
                <div class="song-preview-side">
                    <div id="preview-art" class="w-full aspect-square bg-white/5 rounded-3xl mb-8 flex items-center justify-center overflow-hidden border-8 border-white transform rotate-[-2deg]">
                        <div class="text-[12rem] opacity-30">üî•</div>
                    </div>
                    <h2 id="preview-title" class="text-7xl font-black italic uppercase leading-none mb-2" style="text-shadow: 5px 5px 0 var(--fnf-pink)">SONG TITLE</h2>
                    <p id="preview-artist" class="text-3xl text-cyan-400 mb-10 font-bold tracking-tighter">ARTIST NAME</p>
                    <button class="bg-white text-black hover:bg-pink-500 hover:text-white p-8 text-5xl font-black skew-x-[-12deg] transition-all transform hover:scale-110" onclick="app.startGame()">LETS GO!</button>
                    <button class="mt-8 text-white/40 text-2xl font-bold hover:text-white transition-colors" onclick="app.showScreen('screen-main')">BACK TO STREETS</button>
                </div>
                <div class="song-list-side" id="song-list"></div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div id="judgement" class="judgement">PERFECT</div>
            <div class="highway">
                <div class="lane" onpointerdown="app.handleInput(0)" onpointerup="app.releaseInput(0)" onpointerleave="app.releaseInput(0)">
                    <div class="receptor" id="receptor-0" style="color:var(--note-left)">‚Üê</div>
                </div>
                <div class="lane" onpointerdown="app.handleInput(1)" onpointerup="app.releaseInput(1)" onpointerleave="app.releaseInput(1)">
                    <div class="receptor" id="receptor-1" style="color:var(--note-down)">‚Üì</div>
                </div>
                <div class="lane" onpointerdown="app.handleInput(2)" onpointerup="app.releaseInput(2)" onpointerleave="app.releaseInput(2)">
                    <div class="receptor" id="receptor-2" style="color:var(--note-up)">‚Üë</div>
                </div>
                <div class="lane" onpointerdown="app.handleInput(3)" onpointerup="app.releaseInput(3)" onpointerleave="app.releaseInput(3)">
                    <div class="receptor" id="receptor-3" style="color:var(--note-right)">‚Üí</div>
                </div>
            </div>
            <div class="absolute top-10 right-10 text-5xl font-black italic text-white" style="text-shadow: 4px 4px 0 var(--fnf-pink)">SCORE: <span id="score-val" class="text-cyan-400">0</span></div>
            <div class="hp-bar"><div id="hp-fill" class="hp-fill" style="width: 50%"></div></div>
        </div>

        <!-- Results Screen -->
        <div id="screen-results" class="screen bg-black/90 p-20 flex-row items-center justify-between">
            <div class="w-1/2 flex flex-col items-start">
                <h1 class="font-['Permanent_Marker'] text-9xl text-white mb-8" style="text-shadow: 10px 10px 0 var(--fnf-pink)">FINISH!</h1>
                
                <div class="space-y-4 w-full">
                    <div class="flex justify-between items-center bg-white/5 p-6 border-l-8 border-[var(--fnf-cyan)]">
                        <span class="text-4xl font-black">PERFECT</span>
                        <span id="res-perfect" class="text-6xl font-black text-[var(--fnf-cyan)]">0</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-6 border-l-8 border-[var(--fnf-yellow)]">
                        <span class="text-4xl font-black">GOOD</span>
                        <span id="res-good" class="text-6xl font-black text-[var(--fnf-yellow)]">0</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-6 border-l-8 border-orange-500">
                        <span class="text-4xl font-black">BAD</span>
                        <span id="res-bad" class="text-6xl font-black text-orange-500">0</span>
                    </div>
                    <div class="flex justify-between items-center bg-white/5 p-6 border-l-8 border-gray-600">
                        <span class="text-4xl font-black text-gray-500">MISS</span>
                        <span id="res-miss" class="text-6xl font-black text-gray-500">0</span>
                    </div>
                </div>

                <div class="mt-12 flex space-x-12 items-end">
                    <div>
                        <div class="text-2xl font-bold text-white/40 uppercase tracking-widest">Final Score</div>
                        <div id="res-score" class="text-8xl font-black text-white italic">0</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-white/40 uppercase tracking-widest">Accuracy</div>
                        <div id="res-acc" class="text-8xl font-black text-[var(--fnf-pink)] italic">0%</div>
                    </div>
                </div>

                <button class="mt-16 street-menu-btn" onclick="app.showScreen('screen-select')">CONTINUE</button>
            </div>

            <div class="w-1/2 flex flex-col items-center justify-center">
                <div class="text-4xl font-black text-white/20 mb-[-2rem]">RANK</div>
                <div id="res-rank" class="rank-badge">S</div>
                <div id="res-msg" class="text-3xl font-bold italic text-white/60 text-center mt-10">LEGENDARY PERFORMANCE</div>
            </div>
        </div>
    </div>

    <script>
        const SONGS = [
            { 
                title: "TEACH ME DOUGIE", 
                artist: "BOUDHA CREW REMIX", 
                bpm: 85, 
                color: "#ff00ff",
                url: "https://dl.dropboxusercontent.com/scl/fi/wub4nwe9v57udxwf7dojc/Teach-Me-How-to-Dougie-Steelies-Of-Boudha-Crew-Dance-Cover-Choreography-by-MannexManhattan.mp3?rlkey=spzt7op2ctq2f5ct2u7gy2h35"
            }
        ];

        class Game {
            constructor() {
                this.canvas = document.getElementById('bg-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.selectedIndex = 0;
                this.isPlaying = false;
                
                // Stats
                this.score = 0;
                this.health = 50;
                this.stats = { perfect: 0, good: 0, bad: 0, miss: 0 };
                
                this.notes = [];
                this.startTime = 0;
                this.audioCtx = null;
                this.analyser = null;
                this.dataArray = null;
                this.currentAudio = null;
                this.source = null;

                this.init();
            }

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.renderSongs();
                
                const keyMap = { 'ArrowLeft': 0, 'ArrowDown': 1, 'ArrowUp': 2, 'ArrowRight': 3 };
                window.addEventListener('keydown', (e) => {
                    if (this.isPlaying && keyMap[e.key] !== undefined && !e.repeat) {
                        e.preventDefault();
                        this.handleInput(keyMap[e.key]);
                    }
                });
                window.addEventListener('keyup', (e) => {
                    if (this.isPlaying && keyMap[e.key] !== undefined) {
                        this.releaseInput(keyMap[e.key]);
                    }
                });

                this.bgLoop();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            initAudio() {
                if(this.audioCtx) return;
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioCtx.createAnalyser();
                this.analyser.fftSize = 128;
                this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
            }

            toMenu() {
                this.initAudio();
                this.showScreen('screen-main');
            }

            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const target = document.getElementById(id);
                if (target) target.classList.add('active');
            }

            renderSongs() {
                const list = document.getElementById('song-list');
                if (!list) return;
                list.innerHTML = SONGS.map((s, i) => `
                    <div class="osu-card ${i === 0 ? 'active' : ''}" id="song-${i}" onclick="app.selectSong(${i})">
                        <div class="title">${s.title}</div>
                        <div class="artist">BY ${s.artist}</div>
                    </div>
                `).join('');
                this.updatePreview();
            }

            selectSong(i) {
                this.selectedIndex = i;
                document.querySelectorAll('.osu-card').forEach((c, idx) => c.classList.toggle('active', idx === i));
                this.updatePreview();
                this.playSfx(150, 'sine');
            }

            updatePreview() {
                const s = SONGS[this.selectedIndex];
                const title = document.getElementById('preview-title');
                const artist = document.getElementById('preview-artist');
                const art = document.getElementById('preview-art');
                if (title) title.innerText = s.title;
                if (artist) artist.innerText = s.artist;
                if (art) art.style.borderColor = s.color;
            }

            playSfx(freq, type = 'square') {
                if(!this.audioCtx) return;
                try {
                    const osc = this.audioCtx.createOscillator();
                    const g = this.audioCtx.createGain();
                    osc.type = type; osc.frequency.value = freq;
                    g.gain.setValueAtTime(0.05, this.audioCtx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.1);
                    osc.connect(g); g.connect(this.audioCtx.destination);
                    osc.start(); osc.stop(this.audioCtx.currentTime + 0.1);
                } catch(e) {}
            }

            async startGame() {
                const song = SONGS[this.selectedIndex];
                if (!song.url) return;

                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.style.display = 'flex';

                try {
                    if (this.currentAudio) {
                        this.currentAudio.pause();
                        this.currentAudio = null;
                    }

                    this.currentAudio = new Audio();
                    this.currentAudio.crossOrigin = "anonymous";
                    this.currentAudio.src = song.url;

                    await new Promise((resolve, reject) => {
                        const onCanPlay = () => {
                            this.currentAudio.removeEventListener('canplay', onCanPlay);
                            this.currentAudio.removeEventListener('error', onError);
                            resolve();
                        };
                        const onError = (e) => {
                     
